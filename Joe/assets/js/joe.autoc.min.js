!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.AutocJs=t()}(this,function(){"use strict";var e=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var t=function(){function t(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.attributes={},this.elements={article:null,wrap:null,modal:null,header:null,title:null,body:null,list:null,footer:null,switcher:null,top:null,overlay:null,anchors:[]},this.data={headings:[],chapters:[]},this.timer=null,this.initialize(e).render().addListeners(),this}return e(t,[{key:"initialize",value:function(e){var i,n=this.getElements(),r=this.getData(),a=void 0;return this.set(t.defaults).set(e),a=document.querySelector(this.get("article")),i=this.generateHeadings(a.querySelectorAll(this.get("selector"))),n.article=a,r.headings=i,r.chapters=this.generateChapters(i),this}},{key:"reload",value:function(e){return this.destroy().initialize(e).render().addListeners(),this}},{key:"set",value:function(e,i){var n=t.Utils,r=this.attributes;return 2===arguments.length?r[e]=i:n.isObject(e)&&n.extend(r,e),this}},{key:"get",value:function(e){return this.attributes[e]}},{key:"getElements",value:function(){return this.elements}},{key:"getData",value:function(){return this.data}},{key:"generateHeadings",value:function(e){var i=[],n=t.Utils;return Array.prototype.forEach.call(e,function(e){i.push({id:n.guid("outline-heading"),node:e,tagName:e.tagName,level:parseInt(e.tagName.replace(/[h]/i,""),10)})}),i}},{key:"generateChapters",value:function(e){var i=t.Utils,n=[],r=1,a=0;return e.forEach(function(e,l){var s=e.level,o=-1;s>r?o=1===(a+=1)?-1:l-1:s===r||s<r&&s>a?1===s?(a=1,o=-1):o=n[l-1].pid:s<=a&&(1===s?a=1:(a-=r-s)<=1&&(a=1),o=1===a?-1:t._generatePid(n,r-s,l)),r=s,n.push({id:l,pid:o,level:a,rel:e.id,text:i.stripTags(i.trim(e.node.innerHTML))})}),this.generateChapterCode(n),n}},{key:"generateChapterCode",value:function(e){var i=t.Utils.groupBy(e,"pid");return i.forEach(function(e){e.forEach(function(e,t){e.index=t+1})}),i.forEach(function(t){t.forEach(function(t){e.forEach(function(e){-1===e.pid?e.code=String(e.index):e.pid===t.id&&(e.code=t.code+"."+e.index)})})}),this}},{key:"render",value:function(){return this.renderAnchors().renderOutline(),this}},{key:"renderAnchors",value:function(){var e=this,i=t.Utils.DOM,n=this.getData(),r=n.headings,a=n.chapters,l=this.getElements(),s=this.get("anchorURL");return r.forEach(function(t,n){var r=t.node,o=i.createElement("i",{className:"icon icon-section outline-heading-icon"}),u=s||"#"+t.id,c="front"===e.get("anchorAt")?"outline-heading-anchor-at-front":"outline-heading-anchor-at-end",d=i.createElement("a",{"aria-hidden":!0,className:"outline-heading-anchor "+c+" outline-link outline-hidden",rel:t.id,href:u},[o]),h=void 0;i.addClass(r,"outline-heading"),r.id=t.id,e.get("isGenerateHeadingChapterCode")&&(h=i.createElement("span",{className:"outline-heading-code"},[a[n].code]),r.insertBefore(h,r.firstChild)),e.get("isGenerateHeadingAnchor")&&(r.appendChild(d),l.anchors.push(d))}),this}},{key:"renderOutline",value:function(){var e=this.get("position").toLowerCase();if(!this.get("isGenerateOutline"))return this;switch(e){case"outside":this.renderOutsideOutline();break;case"inside":this.renderInsideOutline()}return this.renderChapters(),this}},{key:"renderOutsideOutline",value:function(){var e=t.Utils.DOM,i=this.getElements(),n=this.get("title");return i.title=e.createElement("h2",{className:"outline-outside-title"},[n]),i.header=e.createElement("div",{className:"outline-outside-header"},[i.title]),i.list=e.createElement("ul",{className:"outline-outside-list"}),i.body=e.createElement("div",{className:"outline-outside-body"},[i.list]),i.switcher=e.createElement("div",{className:"joe_action_item outline-outside-switcher"},[e.createElement("i",{className:"icon icon-menu"})]),i.modal=e.createElement("div",{className:"outline-outside-modal"},[i.header,i.body]),Joe.IS_MOBILE,i.overlay=e.createElement("div",{className:"outline-outside-overlay outline-hidden"}),i.wrap=e.createElement("div",{className:"outline-outside"},[i.modal,i.overlay]),document.body.appendChild(i.wrap),document.getElementsByClassName("joe_action")[0].appendChild(i.switcher),this}},{key:"renderInsideOutline",value:function(){var e=t.Utils.DOM,i=this.getElements(),n=this.get("title");return i.title=e.createElement("h2",{className:"outline-inside-title"},[n]),i.header=e.createElement("div",{className:"outline-inside-header"},[i.title]),i.list=e.createElement("ul",{className:"outline-inside-list"}),i.body=e.createElement("div",{className:"outline-inside-body"},[i.list]),i.wrap=e.createElement("div",{className:"outline-inside"},[i.header,i.body]),i.article.insertBefore(i.wrap,i.article.firstChild),this}},{key:"renderChapters",value:function(){var e=this,i=this.getData().chapters,n=t.Utils.DOM,r=this.getElements().list;return i.forEach(function(t){var i,a=t.pid,l=void 0,s=void 0,o=void 0,u=n.createElement("span",{className:"outline-chapter-text"},[t.text]),c=n.createElement("a",{className:"outline-link",href:"#"+t.rel,rel:t.rel},[u]),d=[];e.get("isGenerateOutlineChapterCode")&&(o=n.createElement("span",{className:"outline-chapter-code"},[t.code]),d.push(o)),d.push(c),i=n.createElement("li",{id:"outline-chapter-"+t.id,className:"outline-chapter"},d),-1===a?r.appendChild(i):(l=document.getElementById("outline-chapter-"+a),(s=document.getElementById("outline-subject-"+a))?s.appendChild(i):(s=n.createElement("ul",{id:"outline-subject-"+a,className:"outline-subject"},[i]),l.appendChild(s)))}),this}},{key:"scrollTo",value:function(e){var i=this,n=t.Utils,r=document.querySelectorAll("html,body"),a=r[0].scrollTop-r[1].scrollTop>=0?r[0]:r[1],l=a.scrollTop,s=e-a.scrollTop<0,o=a.scrollHeight-window.innerHeight,u=e-o<=0?e:o,c=0;return function t(){if(i.timer&&i.stop(),c+=1,s){if(l-=n.easeInQuad(c),a.scrollTop=l,a.scrollTop<=e)return a.scrollTop=e,i.stop(),!1}else if(l+=n.easeInQuad(c),a.scrollTop=l,a.scrollTop>=u)return a.scrollTop=u,i.stop(),!1;i.timer=setTimeout(t,30)}(),this}},{key:"stop",value:function(){return clearTimeout(this.timer),this.timer=null,this}},{key:"show",value:function(){var e=this.getElements();return t.Utils.DOM.addClass(e.modal,"outline-outside-modal-opened"),$(e.overlay).fadeIn(500),this}},{key:"hide",value:function(){var e=this.getElements();return t.Utils.DOM.removeClass(e.modal,"outline-outside-modal-opened"),$(e.overlay).fadeOut(500),this}},{key:"toggle",value:function(){return t.Utils.DOM.hasClass(this.getElements().modal,"outline-outside-modal-opened")?this.hide():this.show(),this}},{key:"remove",value:function(){var e=this.getElements(),t=e.wrap;return this.removeListeners(),this.get("isGenerateHeadingAnchor")&&e.anchors.forEach(function(e){e.parentNode.removeChild(e)}),t.parentNode.removeChild(t),this}},{key:"destroy",value:function(){return this.remove(),this.attributes={},this.elements={article:null,wrap:null,modal:null,header:null,title:null,body:null,list:null,footer:null,switcher:null,top:null,overlay:null,anchors:[]},this.data={headings:[],chapters:[]},this.timer=null,this}},{key:"removeListeners",value:function(){var e=this.getElements(),i=e.article,n=e.wrap,r=t.Utils.Events.off,a=this.get("position").toLowerCase();return r(i,"mouseenter",this._handleArticleHeadingMouseEnter),r(i,"mouseleave",this._handleArticleHeadingMouseLeave),"outside"===a&&(r(n,"click",this._handleSwitcherClick),r(n,"click",this._handleTopClick),r(n,"click",this._handleOverlayClick)),r(n,"click",this._handleChapterClick),this.get("isGenerateHeadingAnchor")&&r(i,"click",this._handleHeadingAnchorClick),this}},{key:"addListeners",value:function(){var e=this.getElements(),i=e.article,n=e.wrap,r=t.Utils.Events.delegate,a=this.get("position").toLowerCase();return r(i,".outline-heading","mouseenter",this._handleArticleHeadingMouseEnter,this),r(i,".outline-heading","mouseleave",this._handleArticleHeadingMouseLeave,this),"outside"===a&&(r(document.getElementsByClassName("joe_action")[0],".outline-outside-switcher","click",this._handleSwitcherClick,this),r(n,".outline-outside-top","click",this._handleTopClick,this),r(n,".outline-outside-overlay","click",this._handleOverlayClick,this)),r(n,".outline-link","click",this._handleChapterClick,this),this.get("isGenerateHeadingAnchor")&&r(i,".outline-heading-anchor","click",this._handleHeadingAnchorClick,this),this}},{key:"_handleArticleHeadingMouseEnter",value:function(e){var i=e.delegateTarget.querySelector(".outline-heading-anchor");return i&&t.Utils.DOM.removeClass(i,"outline-hidden"),this}},{key:"_handleArticleHeadingMouseLeave",value:function(e){var i=e.delegateTarget.querySelector(".outline-heading-anchor");return i&&t.Utils.DOM.addClass(i,"outline-hidden"),this}},{key:"_handleHeadingAnchorClick",value:function(e){var i=$(".joe_header").height(),n=e.delegateTarget.getAttribute("rel"),r=document.querySelector("#"+n),a=t.Utils,l=a.DOM,s=a.Events,o=l.offset(r).top-i-10;return a.isEmpty(this.get("anchorURL"))&&(this.stop().scrollTo(o),s.stop(e)),this}},{key:"_handleChapterClick",value:function(e){var i=$(".joe_header").height(),n=e.delegateTarget.getAttribute("rel"),r=document.querySelector("#"+n),a=t.Utils,l=a.DOM,s=a.Events,o=l.offset(r).top-i-20;return"outside"===this.get("position")&&this.hide(),this.stop().scrollTo(o),s.stop(e),this}},{key:"_handleSwitcherClick",value:function(){return this.toggle(),this}},{key:"_handleTopClick",value:function(e){var i=t.Utils.Events;return this.stop().scrollTo(0),i.stop(e),this}},{key:"_handleOverlayClick",value:function(){return this.hide(),this}}]),t}();return t.defaults={article:"#article",selector:"h1,h2,h3,h4,h5,h6",title:"文章导读",position:"outside",anchorURL:"",anchorAt:"front",isGenerateOutline:!0,isGenerateOutlineChapterCode:!0,isGenerateHeadingChapterCode:!1,isGenerateHeadingAnchor:!0},t.Utils={uuid:0,isObject:function(e){return"[object Object]"===Object.prototype.toString.apply(e)&&null!==e},isArray:function(e){return Array.isArray?Array.isArray(e):"[object Array]"===Object.prototype.toString.apply(e)},isElement:function(e){return e&&e.nodeName&&e.tagName&&1===e.nodeType},isEmpty:function(e){return"string"==typeof e&&""===e},guid:function(e){var i=t.Utils;return i.uuid+=1,e?e+"-"+i.uuid:"guid-"+i.uuid},trim:function(e){return e.replace(/^\s+/g,"").replace(/\s+$/g,"")},stripTags:function(e){return e.replace(/<\/?[^>]+(>|$)/g,"")},groupBy:function(e,t){var i={};return e.forEach(function(e){var n=JSON.stringify(function(e){return[e[t]]}(e));i[n]=i[n]||[],i[n].push(e)}),Object.keys(i).map(function(e){return i[e]})},easeInQuad:function(e){return e*e},extend:function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])}},t.Utils.DOM={createElement:function(e,i,n){var r=t.Utils,a=r.DOM,l=document.createElement(e);for(var s in i)i.hasOwnProperty(s)&&a.setAttribute(l,s,i[s]);return r.isArray(n)&&n.forEach(function(e){var t=r.isElement(e)?e:document.createTextNode(e);l.appendChild(t)}),l},setAttribute:function(e,t,i){var n=e.tagName.toLowerCase();switch(t){case"style":e.style.cssText=i;break;case"value":"input"===n||"textarea"===n?e.value=i:e.setAttribute(t,i);break;case"className":e.className=i;break;default:e.setAttribute(t,i)}},hasClass:function(e,t){var i=e.className;return!!i&&i.match(new RegExp("(\\s|^)"+t+"(\\s|$)"))},addClass:function(e,i){var n=e.className;if(t.Utils.DOM.hasClass(e,i))return!1;n+=n.length>0?" "+i:i,e.className=n},removeClass:function(e,i){var n=t.Utils,r=e.className;if(!r||!n.DOM.hasClass(e,i))return!1;r=n.trim(r.replace(i,"")),e.className=r},offset:function(e){var i=t.Utils.DOM;return{left:i.offsetLeft(e),top:i.offsetTop(e)}},offsetTop:function(e){var i=t.Utils.DOM,n=e.offsetTop;return null!==e.offsetParent&&(n+=i.offsetTop(e.offsetParent)),n},offsetLeft:function(e){var i=t.Utils.DOM,n=e.offsetLeft;return null!==e.offsetParent&&(n+=i.offsetLeft(e.offsetParent)),n}},t.Utils.Events={delegate:function(e,i,n,r,a,l){"mouseenter"!==n&&"mouseleave"!==n||(l=!0),r._delegateWrapper=r,e.addEventListener(n,function(n){(n.delegateTarget=t.getDelegateTarget(e,n.target,i))&&r.call(a||e,n)},l||!1)},off:function(e,t,i,n){i._delegateWrapper&&delete(i=i._delegateWrapper)._delegateWrapper,"mouseenter"!==t&&"mouseleave"!==t||(n=!0),e.removeEventListener(t,i,n||!1)},stop:function(e){var i=t.Utils.Events;i.stopPropagation(e),i.preventDefault(e)},stopPropagation:function(e){var t=window.event;e.stopPropagation?e.stopPropagation():t.cancelBubble=!0},preventDefault:function(e){var t=window.event;e.preventDefault?e.preventDefault():t.returnValue=!1}},t.getDelegateTarget=function(e,i,n){for(;i&&i!==e;){if(t.Utils.DOM.hasClass(i,n.replace(".","")))return i;i=i.parentElement}return null},t._generatePid=function(e,t,i){var n=void 0;switch(t){case 2:n=e[e[e[i-1].pid].pid].pid;break;case 3:n=e[e[e[e[i-1].pid].pid].pid].pid;break;case 4:n=e[e[e[e[e[i-1].pid].pid].pid].pid].pid;break;case 5:n=e[e[e[e[e[e[i-1].pid].pid].pid].pid].pid].pid;break;default:n=e[e[i-1].pid].pid}return n},window.jQuery&&$.extend($.fn,{articleOutline:function(e){var i=$(this);return new t($.extend({},e,{article:i}))}}),t});